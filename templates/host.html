<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Host ‚Ä¢ Memory Match</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">
    <h1>üéõÔ∏è Host Dashboard</h1>
    <p class="muted">Create a lobby, then start the round when you‚Äôre ready.</p>

    <div class="card">
      <div class="row">
        <label>Host Key</label>
        <input id="hostKey" placeholder="Enter host key" />
      </div>

      <div class="row">
        <label>Mode</label>
        <select id="mode">
          <option value="solo" selected>Solo</option>
          <option value="teams">Teams</option>
        </select>
      </div>

      <!-- ‚úÖ NEW: Board preset dropdown -->
      <div class="row">
        <label>Board</label>
        <select id="board">
          <option value="4x4">4√ó4 (16)</option>
          <option value="5x4">5√ó4 (20)</option>
          <option value="6x4">6√ó4 (24)</option>
          <option value="6x5">6√ó5 (30)</option>
          <option value="6x6" selected>6√ó6 (36)</option>
        </select>
      </div>

      <div class="row">
        <label>Entry</label>
        <select id="entryMode">
          <option value="free" selected>Free</option>
          <option value="ticket">Ticket Required</option>
        </select>
      </div>

      <button class="btn" id="createBtn" type="button">Create Lobby</button>
      <p class="tiny muted" style="margin-top:10px;">Bookmark your secret host link so your key auto-fills.</p>

      <p id="errBox" class="tiny" style="margin-top:10px; display:none;"></p>
    </div>

    <div class="card" id="lobbyCard" style="display:none">
      <h2>Lobby</h2>
      <div class="pill">Code: <span id="code"></span></div>

      <div class="muted tiny" style="margin-top:8px; line-height:1.8;">
        Join link: <span id="joinLink"></span>
        <button class="btn outline" id="copyJoinBtn" type="button">Copy</button><br/>

        Player view: <span id="playLink"></span>
        <button class="btn outline" id="copyPlayBtn" type="button">Copy</button><br/>

        Spectator link: <span id="watchLink"></span>
        <button class="btn outline" id="copyWatchBtn" type="button">Copy</button>
      </div>

      <!-- ‚úÖ HOST CONTROLS -->
      <div class="grid2" style="margin-top:14px;">
        <button class="btn" id="startBtn" type="button">Start Round</button>
        <button class="btn outline" id="endBtn" type="button">End Round</button>
        <button class="btn outline" id="resetBtn" type="button">Next Round (new board)</button>
        <a class="btn outline" id="openPlayBtn" href="#" target="_blank">Open Player View</a>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div><b>Status:</b> <span id="status"></span></div>
        <div><b>Players:</b> <span id="playersCount"></span> / 10</div>
      </div>

      <!-- CHAT BLURB -->
      <div class="hr"></div>
      <h3>Chat Blurb (copy/paste)</h3>
      <textarea id="chatBlurb"
        style="width:100%;min-height:110px;border-radius:12px;padding:10px;background:rgba(11,15,25,.55);color:#e8ebf3;border:1px solid rgba(39,50,74,1);"
        readonly></textarea>
      <div class="grid2" style="margin-top:10px;">
        <button class="btn outline" id="copyChatBtn" type="button">üìã Copy Chat Blurb</button>
        <button class="btn outline" id="toggleChatBtn" type="button">Make it shorter</button>
      </div>

      <!-- PRIZES -->
      <div class="hr"></div>
      <h3>Prizes</h3>
      <div class="row"><label>1st</label><input id="p1" placeholder="e.g. $25 / prize name"></div>
      <div class="row"><label>2nd</label><input id="p2" placeholder="e.g. $10 / prize name"></div>
      <div class="row"><label>3rd</label><input id="p3" placeholder="e.g. $5 / prize name"></div>
      <button class="btn outline" id="savePrizesBtn" type="button">Save Prizes</button>
      <p class="tiny muted" id="prizeSaved" style="margin-top:8px;"></p>

      <!-- WINNERS -->
      <div id="winnersCard" class="card inner" style="display:none;margin-top:14px;">
        <h3 style="margin-top:0;">üèÜ Winners</h3>
        <div id="winnersBox" class="tiny"></div>
        <button class="btn outline" id="copyWinnersBtn" style="margin-top:10px;" type="button">üìã Copy Winners</button>
      </div>

      <!-- PLAYERS + KICK -->
      <div class="hr"></div>
      <h3>Players (Kick controls)</h3>
      <div id="playersBox"></div>

      <!-- LEADERBOARD -->
      <div class="hr"></div>
      <h3>Leaderboard</h3>
      <div id="teamsBox" style="display:none"></div>
      <div id="lb"></div>
    </div>
  </div>

<script>
function el(id){ return document.getElementById(id); }
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function getParam(name){ return new URLSearchParams(window.location.search).get(name); }

const urlKey = getParam("host_key");
if(urlKey) el("hostKey").value = urlKey;

function showErr(msg){
  const box = el("errBox");
  box.style.display = "block";
  box.style.color = "#ffb4b4";
  box.textContent = msg;
}

async function copyText(txt){
  try { await navigator.clipboard.writeText(txt); alert("Copied!"); }
  catch { alert("Could not copy automatically. You can manually select + copy."); }
}

async function hostPost(path, body){
  const hostKey = el("hostKey").value.trim();

  const res = await fetch(path, {
    method: "POST",
    headers: { "Content-Type":"application/json", "X-Host-Key": hostKey },
    body: JSON.stringify(body || {})
  });

  const text = await res.text();
  let data = null;
  try { data = JSON.parse(text); } catch(e) {}

  if(!res.ok){
    const msg = (data && (data.error || data.message)) || text.slice(0,220) || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data || { ok:true };
}

let lobbyCode = null;
let cachedLinks = { join:"", play:"", watch:"" };
let chatMode = "long";
let lastWinnersText = "";

function buildChatBlurb(entryMode){
  const code = lobbyCode || "";
  const join = cachedLinks.join;
  const watch = cachedLinks.watch;

  if(chatMode === "short"){
    return `üÉè Memory Match!\nCODE: ${code}\nJoin: ${join}\n${entryMode === "ticket" ? "üéüÔ∏è Ticket required" : "‚úÖ Free entry"}\nWatch: ${watch}`;
  }
  return `üÉè Memory Match is LIVE!\n` +
         `Go to: ${join}\n` +
         `Click Join a Game\n` +
         `Enter CODE: ${code}\n` +
         `${entryMode === "ticket" ? "üéüÔ∏è Ticket required\n" : "‚úÖ Free entry\n"}` +
         `üëÄ Spectate: ${watch}`;
}

function lbHtml(players){
  let html = `<table class="tbl">
    <tr><th>#</th><th>Name</th><th>Team</th><th>Score</th><th>Matches</th><th>Misses</th></tr>`;
  (players||[]).slice(0,10).forEach((r,i)=>{
    html += `<tr>
      <td>${i+1}</td><td>${esc(r.name)}</td><td>${esc(r.team||"")}</td>
      <td>${r.score}</td><td>${r.matches}</td><td>${r.misses}</td>
    </tr>`;
  });
  html += `</table>`;
  return html;
}

function teamsHtml(teams){
  let html = `<div class="card inner"><h4>Teams (best 3 combined)</h4>`;
  html += `<table class="tbl"><tr><th>#</th><th>Team</th><th>Score</th><th>Top 3</th></tr>`;
  (teams||[]).forEach((t,i)=>{
    html += `<tr><td>${i+1}</td><td>${esc(t.team)}</td><td>${t.score}</td><td>${esc((t.members||[]).join(", "))}</td></tr>`;
  });
  html += `</table></div>`;
  return html;
}

function playersHtml(players){
  if(!players || !players.length) return `<div class="tiny muted">No players yet.</div>`;
  let html = `<table class="tbl"><tr><th>Name</th><th>Team</th><th>Score</th><th></th></tr>`;
  players.forEach(p=>{
    html += `<tr>
      <td>${esc(p.name)}</td>
      <td>${esc(p.team||"")}</td>
      <td>${p.score}</td>
      <td><button class="btn outline kickBtn" data-pid="${p.player_id}" type="button">Kick</button></td>
    </tr>`;
  });
  html += `</table>`;
  return html;
}

function renderWinners(lobby, lb){
  const prizes = lobby.prizes || {};
  if(lobby.status !== "ended"){ el("winnersCard").style.display="none"; lastWinnersText=""; return; }

  let lines = [];
  if(lobby.mode === "teams"){
    const t = lb.teams || [];
    if(prizes["1"]) lines.push(`1st (${prizes["1"]}): ${t[0] ? t[0].team : "‚Äî"}`);
    if(prizes["2"]) lines.push(`2nd (${prizes["2"]}): ${t[1] ? t[1].team : "‚Äî"}`);
    if(prizes["3"]) lines.push(`3rd (${prizes["3"]}): ${t[2] ? t[2].team : "‚Äî"}`);
  } else {
    const p = lb.players || [];
    if(prizes["1"]) lines.push(`1st (${prizes["1"]}): ${p[0] ? p[0].name : "‚Äî"}`);
    if(prizes["2"]) lines.push(`2nd (${prizes["2"]}): ${p[1] ? p[1].name : "‚Äî"}`);
    if(prizes["3"]) lines.push(`3rd (${prizes["3"]}): ${p[2] ? p[2].name : "‚Äî"}`);
  }

  el("winnersBox").innerHTML = lines.map(l=>`<div>${esc(l)}</div>`).join("");
  lastWinnersText = lines.join("\n");
  el("winnersCard").style.display = "block";
}

async function refreshLobby(){
  if(!lobbyCode) return;

  const res = await fetch(`/api/lobby/${lobbyCode}`);
  const data = await res.json();
  if(!data.ok) return;

  const lobby = data.lobby;

  el("status").textContent = lobby.status;
  el("playersCount").textContent = lobby.player_count;

  el("chatBlurb").value = buildChatBlurb(lobby.entry_mode);

  el("lb").innerHTML = lbHtml(data.leaderboard.players);
  if(lobby.mode === "teams" && (data.leaderboard.teams||[]).length){
    el("teamsBox").style.display = "block";
    el("teamsBox").innerHTML = teamsHtml(data.leaderboard.teams);
  } else {
    el("teamsBox").style.display = "none";
    el("teamsBox").innerHTML = "";
  }

  renderWinners(lobby, data.leaderboard);

  el("playersBox").innerHTML = playersHtml(data.leaderboard.players);
  document.querySelectorAll(".kickBtn").forEach(btn=>{
    btn.onclick = async ()=>{
      const pid = btn.dataset.pid;
      if(!confirm("Kick this player?")) return;
      try{
        const out = await hostPost(`/api/host/kick/${lobbyCode}`, {player_id: pid});
        if(!out.ok) alert(out.error || "Kick failed");
        refreshLobby();
      }catch(e){
        alert("Kick failed:\n"+e.message);
      }
    };
  });
}

el("createBtn").onclick = async ()=>{
  el("errBox").style.display = "none";
  try{
    const mode = el("mode").value;
    const entry_mode = el("entryMode").value;

    // ‚úÖ NEW: board -> rows/cols
    const board = el("board").value; // like "6x5"
    const [cols, rows] = board.split("x").map(n => parseInt(n, 10));

    // ‚úÖ IMPORTANT: this requires app.py to accept rows/cols (next step)
    const out = await hostPost("/api/host/create_lobby", { mode, rows, cols, entry_mode });
    if(!out.ok) throw new Error(out.error || "Create lobby failed");

    lobbyCode = out.lobby.code;
    el("lobbyCard").style.display = "block";
    el("code").textContent = lobbyCode;

    cachedLinks.join  = `${location.origin}/join`;
    cachedLinks.play  = `${location.origin}/play/${lobbyCode}`;
    cachedLinks.watch = `${location.origin}/watch/${lobbyCode}`;

    el("joinLink").textContent = cachedLinks.join;
    el("playLink").textContent = cachedLinks.play;
    el("watchLink").textContent = cachedLinks.watch;
    el("openPlayBtn").href = cachedLinks.play;

    el("copyJoinBtn").onclick = () => copyText(cachedLinks.join);
    el("copyPlayBtn").onclick = () => copyText(cachedLinks.play);
    el("copyWatchBtn").onclick = () => copyText(cachedLinks.watch);

    el("copyChatBtn").onclick = () => copyText(el("chatBlurb").value.trim());
    el("toggleChatBtn").onclick = () => {
      chatMode = (chatMode === "long") ? "short" : "long";
      el("toggleChatBtn").textContent = (chatMode === "long") ? "Make it shorter" : "Make it longer";
      el("chatBlurb").value = buildChatBlurb(entry_mode);
    };

    el("startBtn").onclick = async ()=>{
      try{
        const out2 = await hostPost(`/api/host/start_round/${lobbyCode}`, {});
        if(!out2.ok) alert(out2.error || "Start failed");
        refreshLobby();
      }catch(e){ alert("Start failed:\n"+e.message); }
    };

    el("endBtn").onclick = async ()=>{
      try{
        const out2 = await hostPost(`/api/host/end_round/${lobbyCode}`, {});
        if(!out2.ok) alert(out2.error || "End failed");
        refreshLobby();
      }catch(e){ alert("End failed:\n"+e.message); }
    };

    el("resetBtn").onclick = async ()=>{
      try{
        const out2 = await hostPost(`/api/host/reset_lobby/${lobbyCode}`, {});
        if(!out2.ok) alert(out2.error || "Reset failed");
        refreshLobby();
      }catch(e){ alert("Reset failed:\n"+e.message); }
    };

    el("savePrizesBtn").onclick = async ()=>{
      try{
        const p1 = el("p1").value.trim();
        const p2 = el("p2").value.trim();
        const p3 = el("p3").value.trim();
        const out2 = await hostPost(`/api/host/set_prizes/${lobbyCode}`, {p1, p2, p3});
        if(!out2.ok) throw new Error(out2.error || "Save failed");
        el("prizeSaved").textContent = "‚úÖ Prizes saved.";
        setTimeout(()=>{ el("prizeSaved").textContent = ""; }, 1800);
        refreshLobby();
      }catch(e){
        alert("Save prizes failed:\n"+e.message);
      }
    };

    el("copyWinnersBtn").onclick = () => {
      if(lastWinnersText) copyText(lastWinnersText);
      else alert("No winners yet.");
    };

    refreshLobby();
  }catch(err){
    showErr("Create Lobby failed: " + err.message);
    alert("Create Lobby failed:\n" + err.message);
  }
};

setInterval(refreshLobby, 1000);
</script>
</body>
</html>
