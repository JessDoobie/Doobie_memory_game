<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Host ‚Ä¢ Memory Match</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <h1>üé≤ Host Dashboard</h1>
    </div>
 

<h3>Leaderboard</h3>
<div id="leaderboard"></div>


    <!-- CREATE LOBBY -->
    <div class="card">
      <p class="muted">Create a lobby, then share the code with your chat.</p>

      <div class="row">
        <label for="mode">Mode</label>
        <select id="mode">
          <option value="solo" selected>Solo</option>
          <option value="teams">Teams</option>
        </select>
      </div>

      <div class="row">
  <label for="boardPreset">Board</label>
  <select id="boardPreset">
    <option value="5x4" selected>Standard (4√ó5 ‚Ä¢ 20 cards)</option>
    <option value="6x4">Extended (4√ó6 ‚Ä¢ 24 cards)</option>
    <option value="6x5">XL (5√ó6 ‚Ä¢ 30 cards)</option>
  </select>
</div>


      <div class="row">
        <label for="entry">Entry</label>
        <select id="entry">
          <option value="free" selected>Free</option>
          <option value="paid">Paid</option>
        </select>
      </div>

      <button id="createBtn" class="btn">Create Lobby</button>

      <div id="createStatus" class="tiny muted" style="margin-top:8px;"></div>
    </div>

    <!-- LOBBY INFO -->
    <div id="lobbyBox" class="card" style="display:none;">
      <h3>Lobby</h3>

      <div class="pill" id="codePill">Code: ----</div>

      <div class="hr"></div>

      <p class="tiny muted">
        Join page:<br>
        <strong id="joinLink"></strong>
      </p>

      <p class="tiny muted">
        Direct play link:<br>
        <strong id="playLink"></strong>
      </p>

      <p class="tiny muted">
        Spectator link:<br>
        <strong id="watchLink"></strong>
      </p>

      <button id="startBtn" class="btn">Start Game</button>

      <p class="tiny muted" style="margin-top:6px;">
        Players will see ‚Äúwaiting‚Äù until you start.
      </p>
    </div>

  </div>

  <script>
    const createBtn = document.getElementById("createBtn");
    const startBtn  = document.getElementById("startBtn");
    const statusEl  = document.getElementById("createStatus");
    const lobbyBox  = document.getElementById("lobbyBox");
    const codePill  = document.getElementById("codePill");
    const joinLink  = document.getElementById("joinLink");
    const playLink  = document.getElementById("playLink");
    const watchLink = document.getElementById("watchLink");

    let currentCode = null;

    // Pull host_key from the URL if present: /host?host_key=Doobie7731
    const params = new URLSearchParams(window.location.search);
    const hostKeyFromUrl = params.get("host_key") || "";

    async function postJsonWithTimeout(url, body, ms=15000){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);

      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          signal: controller.signal
        });
        const data = await res.json().catch(() => null);
        return { ok: res.ok, status: res.status, data };
      } finally {
        clearTimeout(t);
      }
    }

    createBtn.onclick = async () => {
      statusEl.textContent = "Creating lobby‚Ä¶";
      createBtn.disabled = true;

      const payload = {
        mode: document.getElementById("mode").value,
        board: document.getElementById("board").value,
        entry: document.getElementById("entry").value,
      };

      // If your backend expects host_key, this will satisfy it.
      if(hostKeyFromUrl) payload.host_key = hostKeyFromUrl;

      try{
        const resp = await postJsonWithTimeout("/api/create", payload, 20000);

        // Fetch failed / timed out
        if(!resp.data){
          statusEl.textContent = "‚ùå Server didn‚Äôt respond. Check Render logs (app may be sleeping or crashed).";
          createBtn.disabled = false;
          return;
        }

        // Backend returned an error
        if(!resp.data.ok){
          statusEl.textContent = "‚ùå " + (resp.data.error || ("Create failed (HTTP " + resp.status + ")"));
          createBtn.disabled = false;
          return;
        }

        currentCode = resp.data.code;

        statusEl.textContent = "Lobby created ‚úÖ";
        lobbyBox.style.display = "block";

        codePill.textContent = "Code: " + currentCode;
        joinLink.textContent  = location.origin + "/join";
        playLink.textContent  = location.origin + "/play/" + currentCode;
        watchLink.textContent = location.origin + "/watch/" + currentCode;

      } catch (e){
        if(e.name === "AbortError"){
          statusEl.textContent = "‚è≥ Timed out. Render free tier may be waking up OR /api/create is erroring. Check logs.";
        } else {
          statusEl.textContent = "‚ùå Network error: " + e.message;
        }
        createBtn.disabled = false;
      }
    };

    startBtn.onclick = async () => {
      if (!currentCode) return;

      startBtn.disabled = true;
      startBtn.textContent = "Starting‚Ä¶";

      const payload = { code: currentCode };
      if(hostKeyFromUrl) payload.host_key = hostKeyFromUrl;

      try{
        const resp = await postJsonWithTimeout("/api/start", payload, 15000);
        if(resp.data && resp.data.ok){
          startBtn.textContent = "Game Started";
        } else {
          startBtn.textContent = "Start Game";
          startBtn.disabled = false;
          alert((resp.data && resp.data.error) ? resp.data.error : "Start failed.");
        }
      } catch (e){
        startBtn.textContent = "Start Game";
        startBtn.disabled = false;
        alert("Network error starting game.");
      }
    };
  </script>
</body>
</html>

