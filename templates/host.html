<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Host ‚Ä¢ Memory Match</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">
    <h1>üéõÔ∏è Host Dashboard</h1>
    <p class="muted">Create a lobby, share the join code with your chat.</p>

    <div class="card">
      <div class="row">
        <label>Host Key</label>
        <input id="hostKey" placeholder="Enter host key" />
      </div>

      <div class="row">
        <label>Mode</label>
        <select id="mode">
          <option value="solo" selected>Solo</option>
          <option value="teams">Teams</option>
        </select>
      </div>

      <div class="row">
        <label>Board Size</label>
        <select id="size">
          <option value="4">4x4 (quick)</option>
          <option value="6" selected>6x6 (standard)</option>
        </select>
      </div>

      <div class="row">
        <label>Entry</label>
        <select id="entryMode">
          <option value="free" selected>Free</option>
          <option value="ticket">Ticket Required</option>
        </select>
      </div>

      <button class="btn" id="createBtn" type="button">Create Lobby</button>
      <p class="tiny muted" style="margin-top:10px;">Bookmark your secret host link so your key auto-fills.</p>

      <p id="errBox" class="tiny" style="margin-top:10px; display:none;"></p>
    </div>

    <div class="card" id="lobbyCard" style="display:none">
      <h2>Lobby</h2>
      <div class="pill">Code: <span id="code"></span></div>

      <div class="muted tiny" style="margin-top:8px; line-height:1.5;">
        Join link: <span id="joinLink"></span>
        <button class="btn outline" id="copyJoinBtn" type="button">Copy</button><br/>

        Player view: <span id="playLink"></span>
        <button class="btn outline" id="copyPlayBtn" type="button">Copy</button><br/>

        Spectator link: <span id="watchLink"></span>
        <button class="btn outline" id="copyWatchBtn" type="button">Copy</button>
      </div>

      <div class="hr"></div>
      <h3>Chat Blurb</h3>
      <textarea id="chatBlurb"
        style="width:100%;min-height:110px;border-radius:12px;padding:10px;background:rgba(11,15,25,.55);color:#e8ebf3;border:1px solid rgba(39,50,74,1);"
        readonly></textarea>
      <div class="grid2" style="margin-top:10px;">
        <button class="btn outline" id="copyChatBtn" type="button">üìã Copy Chat Blurb</button>
        <button class="btn outline" id="toggleChatBtn" type="button">Make it shorter</button>
      </div>
    </div>
  </div>

<script>
function el(id){ return document.getElementById(id); }
function getParam(name){ return new URLSearchParams(window.location.search).get(name); }

const urlKey = getParam("host_key");
if(urlKey) el("hostKey").value = urlKey;

function showErr(msg){
  const box = el("errBox");
  box.style.display = "block";
  box.style.color = "#ffb4b4";
  box.textContent = msg;
}

async function copyText(txt){
  try { await navigator.clipboard.writeText(txt); alert("Copied!"); }
  catch { alert("Copy failed ‚Äî you can manually highlight + copy."); }
}

async function hostPost(path, body){
  const hostKey = el("hostKey").value.trim();

  const res = await fetch(path, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Host-Key": hostKey
    },
    body: JSON.stringify(body || {})
  });

  const text = await res.text();

  // Try JSON first
  let data = null;
  try { data = JSON.parse(text); } catch(e) {}

  if(!res.ok){
    const msg = (data && (data.error || data.message)) || text.slice(0, 220) || `HTTP ${res.status}`;
    throw new Error(msg);
  }

  // If it was JSON, return it, else return generic ok
  return data || { ok: true };
}

let lobbyCode = null;
let cachedLinks = { join:"", play:"", watch:"" };
let chatMode = "long";

function buildChatBlurb(entryMode){
  const code = lobbyCode || "";
  const join = cachedLinks.join;
  const watch = cachedLinks.watch;

  if(chatMode === "short"){
    return `üÉè Memory Match!\nCODE: ${code}\nJoin: ${join}\n${entryMode === "ticket" ? "üéüÔ∏è Ticket required" : "‚úÖ Free entry"}\nWatch: ${watch}`;
  }

  return `üÉè Memory Match is LIVE!\n` +
         `Go to: ${join}\n` +
         `Click Join a Game\n` +
         `Enter CODE: ${code}\n` +
         `${entryMode === "ticket" ? "üéüÔ∏è Ticket required\n" : "‚úÖ Free entry\n"}` +
         `üëÄ Spectate: ${watch}`;
}

el("createBtn").onclick = async () => {
  el("errBox").style.display = "none";

  try{
    const mode = el("mode").value;
    const size = parseInt(el("size").value, 10);
    const entry_mode = el("entryMode").value;

    // IMPORTANT: this must match your app.py route
    const out = await hostPost("/api/host/create_lobby", {mode, size, entry_mode});

    if(!out.ok){
      throw new Error(out.error || "Create lobby failed");
    }

    lobbyCode = out.lobby.code;
    el("lobbyCard").style.display = "block";
    el("code").textContent = lobbyCode;

    cachedLinks.join  = `${location.origin}/join`;
    cachedLinks.play  = `${location.origin}/play/${lobbyCode}`;
    cachedLinks.watch = `${location.origin}/watch/${lobbyCode}`;

    el("joinLink").textContent = cachedLinks.join;
    el("playLink").textContent = cachedLinks.play;
    el("watchLink").textContent = cachedLinks.watch;

    el("chatBlurb").value = buildChatBlurb(entry_mode);

    el("copyJoinBtn").onclick = () => copyText(cachedLinks.join);
    el("copyPlayBtn").onclick = () => copyText(cachedLinks.play);
    el("copyWatchBtn").onclick = () => copyText(cachedLinks.watch);
    el("copyChatBtn").onclick  = () => copyText(el("chatBlurb").value.trim());

    el("toggleChatBtn").onclick = () => {
      chatMode = (chatMode === "long") ? "short" : "long";
      el("toggleChatBtn").textContent = (chatMode === "long") ? "Make it shorter" : "Make it longer";
      el("chatBlurb").value = buildChatBlurb(entry_mode);
    };

  }catch(err){
    showErr("Create Lobby failed: " + err.message);
    alert("Create Lobby failed:\n" + err.message);
  }
};
</script>
</body>
</html>
