<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch â€¢ {{ code }}</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 style="margin:0;">ðŸ‘€ Watch</h1>
        <div class="tiny muted">Lobby: <b>{{ code }}</b></div>
      </div>
      <a class="btn outline" href="/join">Join</a>
    </div>

    <div class="card">
      <div class="row">
        <div id="status">Status:</div>
        <div id="meta" class="muted tiny"></div>
      </div>
      <div id="prizesBox" class="tiny muted"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Leaderboard</h3>
      <div id="teamsBox" style="display:none"></div>
      <div id="lb"></div>
    </div>
  </div>

<script>
const code = "{{ code }}";

function el(id){ return document.getElementById(id); }
function escapeHtml(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function lbHtml(players){
  let html = `<table class="tbl">
    <tr><th>#</th><th>Name</th><th>Team</th><th>Score</th><th>Matches</th><th>Misses</th></tr>`;
  (players||[]).slice(0,10).forEach((r,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.team||"")}</td>
      <td>${r.score}</td>
      <td>${r.matches}</td>
      <td>${r.misses}</td>
    </tr>`;
  });
  html += `</table>`;
  return html;
}

function teamsHtml(teams){
  let html = `<div class="card inner"><h4>Teams (best 3 combined)</h4>`;
  html += `<table class="tbl"><tr><th>#</th><th>Team</th><th>Score</th><th>Top 3</th></tr>`;
  (teams||[]).forEach((t,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td>${escapeHtml(t.team)}</td>
      <td>${t.score}</td>
      <td>${escapeHtml((t.members||[]).join(", "))}</td>
    </tr>`;
  });
  html += `</table></div>`;
  return html;
}

function renderPrizes(lobby, players, teams){
  const p = lobby.prizes || {};
  const has = (p["1"] || p["2"] || p["3"]);
  if(!has){
    el("prizesBox").innerHTML = "";
    return;
  }

  const ended = lobby.status === "ended";
  let html = `<b>Prizes</b>: `;
  const parts = [];
  if(p["1"]) parts.push(`1st: ${escapeHtml(p["1"])}`);
  if(p["2"]) parts.push(`2nd: ${escapeHtml(p["2"])}`);
  if(p["3"]) parts.push(`3rd: ${escapeHtml(p["3"])}`);
  html += parts.join(" â€¢ ");

  if(ended){
    html += `<div class="hr"></div><b>Winners</b>: `;
    if(lobby.mode === "teams"){
      const t = (teams||[]);
      const winParts = [];
      if(t[0] && p["1"]) winParts.push(`1st: ${escapeHtml(t[0].team)}`);
      if(t[1] && p["2"]) winParts.push(`2nd: ${escapeHtml(t[1].team)}`);
      if(t[2] && p["3"]) winParts.push(`3rd: ${escapeHtml(t[2].team)}`);
      html += winParts.length ? winParts.join(" â€¢ ") : "â€”";
    } else {
      const pl = (players||[]);
      const winParts = [];
      if(pl[0] && p["1"]) winParts.push(`1st: ${escapeHtml(pl[0].name)}`);
      if(pl[1] && p["2"]) winParts.push(`2nd: ${escapeHtml(pl[1].name)}`);
      if(pl[2] && p["3"]) winParts.push(`3rd: ${escapeHtml(pl[2].name)}`);
      html += winParts.length ? winParts.join(" â€¢ ") : "â€”";
    }
  }

  el("prizesBox").innerHTML = html;
}

async function tick(){
  try{
    const res = await fetch(`/api/lobby/${code}`);
    const out = await res.json();
    if(!out.ok) return;

    const lobby = out.lobby;
    el("status").textContent = `Status: ${lobby.status}`;
    el("meta").textContent = `Mode: ${lobby.mode.toUpperCase()} â€¢ Board: ${lobby.size}x${lobby.size} â€¢ Players: ${lobby.player_count}/10`;

    el("lb").innerHTML = lbHtml(out.leaderboard.players);

    if(lobby.mode === "teams" && (out.leaderboard.teams||[]).length){
      el("teamsBox").style.display = "block";
      el("teamsBox").innerHTML = teamsHtml(out.leaderboard.teams);
    } else {
      el("teamsBox").style.display = "none";
      el("teamsBox").innerHTML = "";
    }

    renderPrizes(lobby, out.leaderboard.players, out.leaderboard.teams);
  }catch(e){}
}

tick();
setInterval(tick, 1000);
</script>
</body>
</html>
